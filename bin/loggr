#!/usr/bin/env ruby

args = ARGV.dup
ARGV.clear
command = args.shift.strip rescue 'help'

case command
  when 'help'
    puts <<USAGE
help               # Show this usage.
test               # Send a test exception to Loggr.
alert <message>    # Send a message to Loggr. Exits 0 for success, 1 for config error, and 2 for report failure
install <api_key>  # Create config/loggr.yml with your api_key. Overrites existing one.
install <api_key> <environment> # Create config/loggr.yml with your api_key and enabled for a specific environment. Overrites existing config file.
install <api_key> <environment>,<environment> # Create config/loggr.yml with your api_key enabled for multiple environments (comma seperated). Overrites existing config file.

USAGE
  when 'test'
    if defined?(RAILS_ROOT)
      puts "Loading Rails environment."
      require(File.join('config', 'boot'))
      require(File.join(RAILS_ROOT, 'config', 'environment')) if defined?(RAILS_ROOT)
      require "loggr/integration/tester"
    else 
      require 'json'
      require 'loggr'    
      require "loggr/integration/tester"      
      Loggr::Config.load('config/loggr.yml')
    end    
    if Loggr::Config.api_key
      Loggr::Integration.test
    else
      puts 'API key not configured'
    end
  when 'alert'
    require "loggr"
    require "loggr/alert_data"
    require "loggr/integration/alerter"
    Loggr::Config.load('config/loggr.yml')
    if Loggr::Config.api_key
      exit(Loggr::Integration.alert(args[0]) ? 0 : 2)
    else
      puts 'API key not configured. Put loggr.yml in current directory or /config'
      exit(1)
    end
  when 'install'
    api_key = args[0]
    environments = args[1]
    
    if (api_key.nil?)
      puts 'Missing required paramater <api-key>. Check your app configuration at http://getloggr.com.'
    else
      if (defined?(RAILS_ROOT) && !File.file?('config/environment.rb'))
        puts "Run this command from the root of your rails application." and exit
      else
        Dir.mkdir('config') unless File.exists?('config')        
      end
    end        
    config_file = File.open('config/loggr.yml', 'w')
    config_file.puts("api-key: #{api_key}\n")

    unless(environments.nil?)
      environments.split(',').each do |envo|
        config_file.puts("#{envo}:\n")
        config_file.puts("  enabled: true\n")
      end
    end
    
    config_file.close
    puts "Config file written as config/loggr.yml.";
    puts "----------------------------------------------";
    File.open('config/loggr.yml').readlines.each do |line|
      puts line
    end
    puts "----------------------------------------------";
end
